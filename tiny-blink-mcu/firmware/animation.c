#include "animation.h"
#include "tiny-blink-driver.h"
#include <stdint.h>

uint8_t curanim = 0;
uint8_t curaniindex = 0;

/*	Animation.	*/
const struct animation_t PROGMEM ani[NRANIM] = {
	/*	Ring and john counter.	*/
	CREATE_ANIMIATION(0x0u, 0x1u, 0x2u, 0x4u, 0x8, 0x10u, 0x20u, 0x40u, 0x80u, 0x100u, 0x200u, 0x400u, 0x800u, 0x1000u, 0x2000u, 0x4000u, 0x8000u,
			0x1, 0x3, 0x7u, 0xFu, 0x1Fu, 0x3Fu, 0x7Fu, 0xFFu, 0x1FFu, 0x3FFu, 0x7FFu, 0xFFFu, 0x1FFFu, 0x3FFFu, 0x7FFFu),

	/*	Star and unknown animation.	*/
	CREATE_ANIMIATION(0x8888u, 0x1111u, 0x4444u, 0x8888u, 0x8888u, 0x1111u, 0x4444u, 0x8888u, 0x8888u, 0x1111u, 0x4444u, 0x8888u, 0x8888u, 0x1111u, 0x4444u, 0x8888u,
			0xCCCCu, 0xEEEEu, 0xFFFFu, 0x7FFEu, 0x3FFCu, 0x1FF8u, 0xFF0u, 0x7E0u, 0x3C0u, 0x180u, 0x0, 0x8888u, 0x1111u, 0x4444u, 0x8888u, 0x0),
	/*	*/
	CREATE_ANIMIATION(0x0, 0x1111u, 0x3333u, 0x7777u, 0xFFFFu, 0x7777u, 0x3333u, 0x1111u, 0x0, 0x1111u, 0x3333u, 0x7777u, 0xFFFFu,
			0x7777u, 0x3333u, 0x1111u, 0x0, 0xFFFF, 0x0, 0xFFFFu, 0xF7F7u, 0xF3F3u, 0xF1F1u, 0xF0F0u, 0x7070u, 0x3030u, 0x1010u, 0x0, 0x1111u, 0x3333u, 0x7777u, 0xFFFFu),

	/*	Ring collect.	*/
	CREATE_ANIMIATION(0x0u, 0x1u, 0x11u, 0x111u, 0x1111u, 0x3333u, 0x7777u, 0xFFFFu, 0x7777u, 0x3333u, 0x1111u, 0x2222u, 0x4444u,
			0x0u, 0x1111u, 0x0, 0x2222u, 0x0, 0x1111u, 0x0, 0x2222u, 0x3333u, 0x7777u, 0xFFFFu, 0xEEEEu, 0xCCCCu, 0x8888u, 0x0, 0xFFFFu, 0x0, 0xFFFFu, 0x0),

	//  /*	Ring collect.	*/
	//  CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x0, 14, 15, 14, 12, 10, 8, 6, 4, 2, 0, 0, 2, 4, 8, 10, 12, 14, 15, 14, 12, 10, 8, 6,
	 				//   4, 2, 0),

	//  /*	Ring collect.	*/
	//  CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x0, 14, 15, 14, 12, 10, 8, 6, 4, 2, 0, 0, 2, 4, 8, 10, 12, 14, 15, 14, 12, 10, 8, 6,
	 				//   4, 2, 0),

	//  /*	Ring collect.	*/
	//  CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x0, 14, 15, 14, 12, 10, 8, 6, 4, 2, 0, 0, 2, 4, 8, 10, 12, 14, 15, 14, 12, 10, 8, 6,
	 				//   4, 2, 0),
	//  /*	Ring collect.	*/
	//  CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x0, 14, 15, 14, 12, 10, 8, 6, 4, 2, 0, 0, 2, 4, 8, 10, 12, 14, 15, 14, 12, 10, 8, 6,
	 				//   4, 2, 0),
};

uint16_t cc_get_curr_next_animation_keyframe() {

	/*	Get address and retrieve frame.	*/
	const uint8_t offset = curaniindex;
	const uint16_t *addr = (const uint16_t *)&ani[curanim].ani[offset];
	const uint16_t p = pgm_read_word(addr);

	/*	Update animation index.	*/
	curaniindex++;
	curaniindex %= NRANIMENTRY;

	/*	Next animation.	*/
	if (curaniindex == 0 && (play_mode & PLAY_MODE_AUTO_NEXT_ANIMATION)) {
		reset_for_next_animation();
	}

	return p;
}

inline void reset_for_next_animation() {
	curanim = (curanim + 1) % NRANIM;
	curaniindex = 0;
}

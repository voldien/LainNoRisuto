#include"animation.h"
#include"driver.h"

volatile uint8_t curanim = 0;
volatile uint8_t curaniindex = 0;

/*	Animation.	*/
const struct animation_t PROGMEM ani[NRANIM] = {
		/*	Ring and john counter.	*/
	CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x10, 0x20, 0x40, 0x80, 0x100, 0x200, 0x400, 0x800, 0x1000, 0x2000, 0x4000, 0x8000,
			0x1, 0x3, 0x7, 0xF, 0x1F, 0x3F, 0x7F, 0xFF, 0x1FF, 0x3FF, 0x7FF, 0xFFF, 0x1FFF, 0x3FFF, 0x7FFF),

	/*	Star and unknown animation.	*/
	CREATE_ANIMIATION(0x8888, 0x1111, 0x4444, 0x8888, 0x8888, 0x1111, 0x4444, 0x8888, 0x8888, 0x1111, 0x4444, 0x8888, 0x8888, 0x1111, 0x4444, 0x8888,
			0xCCCC, 0xEEEE, 0xFFFF, 0x7FFE, 0x3FFC, 0x1FF8, 0xFF0, 0x7E0, 0x3C0, 0x180, 0x0, 0x8888, 0x1111, 0x4444, 0x8888, 0x0),
	/*	*/
	CREATE_ANIMIATION(0x0, 0x1111, 0x3333, 0x7777, 0xFFFF, 0x7777, 0x3333, 0x1111, 0x0, 0x1111, 0x3333, 0x7777, 0xFFFF,
			0x7777, 0x3333, 0x1111, 0x0, 0xFFFF, 0x0, 0xFFFF, 0xF7F7, 0xF3F3, 0xF1F1, 0xF0F0, 0x7070, 0x3030, 0x1010, 0x0, 0x1111, 0x3333, 0x7777, 0xFFFF),

	/*	Ring collect.	*/
	CREATE_ANIMIATION(0x0, 0x1, 0x11, 0x111, 0x1111, 0x3333, 0x7777, 0xFFFF, 0x7777, 0x3333, 0x1111, 0x2222, 0x4444,
			0x0, 0x1111, 0x0, 0x2222, 0x0, 0x1111, 0x0, 0x2222, 0x3333, 0x7777, 0xFFFF, 0xEEEE, 0xCCCC, 0x8888, 0x0, 0xFFFF, 0x0, 0xFFFF, 0x0),

	/*	Ring collect.	*/
	CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x0, 14, 15, 14, 12, 10, 8, 6, 4, 2, 0, 0, 2, 4, 8, 10, 12, 14, 15, 14, 12, 10, 8, 6,
					  4, 2, 0),

	/*	Ring collect.	*/
	CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x0, 14, 15, 14, 12, 10, 8, 6, 4, 2, 0, 0, 2, 4, 8, 10, 12, 14, 15, 14, 12, 10, 8, 6,
					  4, 2, 0),

	/*	Ring collect.	*/
	CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x0, 14, 15, 14, 12, 10, 8, 6, 4, 2, 0, 0, 2, 4, 8, 10, 12, 14, 15, 14, 12, 10, 8, 6,
					  4, 2, 0),
	/*	Ring collect.	*/
	CREATE_ANIMIATION(0x0, 0x1, 0x2, 0x4, 0x8, 0x0, 14, 15, 14, 12, 10, 8, 6, 4, 2, 0, 0, 2, 4, 8, 10, 12, 14, 15, 14, 12, 10, 8, 6,
					  4, 2, 0),

};

const uint16_t cc_get_curr_next_animation_keyframe(void) {

	const uint8_t index = curaniindex;

	/*	Get address and retrieve frame.	*/
	const uint8_t offset = index;
	const uint16_t* addr = (const uint16_t*) &ani[curanim].ani[offset];
	const uint16_t p = pgm_read_word(addr);

	/*	Get PWM address and PWM value.	*/
	//const uint16_t* paddr = (const uint16_t*)NULL;
	//uint8_t pwm = pgm_read_byte(paddr);
	//pwm = GET_PWM_8VALUE(pwm, index);
	//set_pwm(pwm);

	/*	Update animation.	*/
	curaniindex++;
	curaniindex %= NRANIMENTRY;

	/*	Next animation.	*/
	if (curaniindex == 0)
		reset_for_next_animation();

	return p;
}

void reset_for_next_animation(void) {
	curanim = (curanim + 1) % NRANIM;
	curaniindex = 0;
}
